-- Blade Ball

local abilities = {}
getgenv().bb_clashCount = 0;

if char:FindFirstChild('Abilities') then
    for i, v in pairs(char:FindFirstChild('Abilities'):GetChildren()) do
        print(v.Name)
        table.insert(abilities, v.Name)
    end
end

SaveManager:SetFolder('Polaris/' .. client.Name .. 'BladeBall')
getgenv().folderSet = true

local vim = game:GetService('VirtualInputManager');

function pressKey(key)
    pcall(function()
        vim:SendKeyEvent(true, Enum.KeyCode[key], false, game)
        wait()
        vim:SendKeyEvent(false, Enum.KeyCode[key], false, game)
    end)
end

function Parry()
    game:GetService("ReplicatedStorage").Remotes.ParryButtonPress:Fire()
end

function ParryAttempt()
    local args = {
        [1] = .5,
        [2] = hrp.CFrame,
        [3] = {
        },
        [4] = {
            [1] = 0,
            [2] = 0
        }
    }

    game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("ParryAttempt"):FireServer(unpack(args))
end

function Clash()
    spawn(function()
        for i = 1, 5 do
            spawn(function()
                ParryAttempt()
            end)
        end
    end)
end

local Main = Window:AddTab('Main');
local LSC1 = Main:AddLeftGroupbox("Auto");
local RSC1 = Main:AddRightGroupbox("Visual");
local RSC2 = Main:AddRightGroupbox("Laggy");

local iced_bb = RSC2:AddButton({
    Text = 'Is this ice?',
    Func = function()
        for i = 1, 100 do
            game:GetService("ReplicatedStorage"):WaitForChild("Remotes"):WaitForChild("Freeze"):FireServer()
        end
    end,
    DoubleClick = false
})

local iced_bbv2 = RSC2:AddToggle('iced_bbv2', {
    Text = 'Ultimate Defense (Freeze)',
    Default = false,

    Callback = function(Value)
        getgenv().bb_defense = Value
    end
});

local function GetBalls()
    local real;
    local fake;

    for _, v in pairs(workspace.Balls:GetChildren()) do
        if v:GetAttribute('realBall') or (v:GetAttribute('target') and v:GetAttribute('target') ~= '') then
            real = v
        else
            fake = v
        end
    end
    return { real, fake }
end

local function GetSpeed()
    local returnValue = 0;

    local balls = GetBalls()

    local b1 = balls[1]
    local b2 = balls[2]

    if b1 and b2 and hrp then
        local speed = b1:FindFirstChild('zoomies').VectorVelocity
        local spX = string.gsub(tostring(speed.X), '-', '')
        spX = tonumber(spX)
        local spZ = string.gsub(tostring(speed.Z), '-', '')
        spZ = tonumber(spZ)
        local spY = string.gsub(tostring(speed.Y), '-', '')
        spY = tonumber(spY)

        returnValue = (spX + spZ + (spY / 2));
    end

    return math.clamp(returnValue, 0, 250);
end

local function GetParryDis()
    local returnValue = 0;

    local balls = GetBalls()

    local b1 = balls[1]
    local b2 = balls[2]

    local speed = GetSpeed() / 2.36

    if b1 and b2 and hrp and speed then
        returnValue = (b2.Position - hrp.Position).magnitude
    end

    return returnValue;
end

local function GetTarget()
    local returnValue;

    local balls = GetBalls()

    local b1 = balls[1]
    local b2 = balls[2]

    if b1 and b2 and hrp then
        returnValue = b1:GetAttribute('target');
    end

    return returnValue;
end

local function IsTarget()
    if GetTarget() == client.Name then
        return true;
    else
        return false;
    end
end

local Part;

local function GetClashColor()
    local clash = bb_clashCount
    local color = Color3.new(1, 1, 1)
    if bb_clashCount <= 1 then
        color = Color3.new(1, 1, 1);
    elseif bb_clashCount == 2 then
        color = Color3.new(1, .5, .5)
    elseif bb_clashCount >= 3 then
        color = Color3.new(1, 0, 0)
    end

    return color;
end

local visualizeRange = RSC1:AddToggle('visualizeRange', {
    Text = 'Visualize Parry Range',
    Default = false,

    Callback = function(Value)
        getgenv().visualizeRange = Value

        if visualizeRange then
            Part = Instance.new('Part')
            Part.Parent = workspace
            Part.Shape = Enum.PartType.Ball
            Part.Material = Enum.Material.ForceField
            Part.Transparency = .2
            spawn(function()
                local connection;

                connection = RunService.RenderStepped:Connect(function()
                    if visualizeRange then
                        if hrp and GetBalls()[1] then
                            Part.CFrame = hrp.CFrame;
                            Part.CanCollide = false;
                            Part.CastShadow = false;
                            local s = GetSpeed() / 2 or 0;
                            game:GetService('TweenService'):Create(Part,
                                TweenInfo.new(.1, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut),
                                { Size = Vector3.new(s, s, s) }):Play();

                            local color = GetClashColor()

                            if color then
                                game:GetService('TweenService'):Create(Part,
                                    TweenInfo.new(.2, Enum.EasingStyle.Linear, Enum.EasingDirection.InOut),
                                    { Color = color })
                                    :Play();
                            end
                        end
                    else
                        connection:Disconnect()
                        if Part then
                            Part:Destroy()
                        end
                    end
                end)
            end)
        else
            if Part then
                Part:Destroy()
            end
        end
    end
});

local TargetChanged = false;

local autoParry = LSC1:AddToggle('autoParry', {
    Text = 'Auto Parry',
    Default = false,

    Callback = function(Value)
        getgenv().bb_AutoParry = Value

        while bb_AutoParry do
            Heartbeat:Wait()

            if IsTarget() then
                local dis = GetParryDis()
                local maxDis = GetSpeed() / 2.36

                if dis <= maxDis then
                    ParryAttempt()
                    local oldTick = tick();
                    local newTick = tick();
                    spawn(function()
                        if previousTarget then
                            local targetDis = (previousTarget:GetModelCFrame().Position - hrp.Position).magnitude

                            if targetDis <= 15 then
                                bb_clashCount = bb_clashCount + 2
                                task.wait(1)
                                bb_clashCount = bb_clashCount - 2
                            else
                                bb_clashCount = bb_clashCount + 1
                                task.wait(1)
                                bb_clashCount = bb_clashCount - 1
                            end
                        else
                            bb_clashCount = bb_clashCount + 1
                            task.wait(1)
                            bb_clashCount = bb_clashCount - 1
                        end
                    end)

                    repeat
                        wait()
                        newTick = tick()
                    until not IsTarget() or (oldTick - newTick >= 60)
                end
            else
                if game:GetService('Players'):FindFirstChild(GetTarget()) then
                    getgenv().previousTarget = game:GetService('Players'):FindFirstChild(GetTarget()).Character
                end
            end
        end
    end
});

LSC1:AddDivider()

local autoClash = LSC1:AddToggle('autoClash', {
    Text = 'Auto Clash',
    Default = false,

    Callback = function(Value)
        getgenv().bb_autoClash = Value

        while bb_autoClash do
            Heartbeat:Wait()
            spaawn(function()
                if bb_clashCount >= 3 then
                    Clash()
                end
            end)
        end
    end
});
